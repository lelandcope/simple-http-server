## LogFile
url		= require 'url'
colors  = require 'colors'
moment	= require 'moment'
path	= require 'path'

module.exports = (root)->
	root = root || './';

	return (req, res, next)->
		try
			pathname = decodeURI url.parse(req.url).pathname
		catch error
			console.log error

		path.exists root+pathname, (exists)->
			unless exists
				console.log '%s - [%s] "%s %s HTTP/%s" 404'.red, getRemoteAddress(req), moment().format('MMM/DD/YYYY HH:mm:ss'), req.method, pathname, (req.httpVersionMajor + '.' + req.httpVersionMinor)
			else
				console.log '%s - [%s] "%s %s HTTP/%s" 200', getRemoteAddress(req), moment().format('MMM/DD/YYYY HH:mm:ss'), req.method, pathname, (req.httpVersionMajor + '.' + req.httpVersionMinor)

		next()


getRemoteAddress = (req)->
	if req.ip then return req.ip
	sock = req.socket
	if sock.socket then return sock.socket.remoteAddress
	return sock.remoteAddress